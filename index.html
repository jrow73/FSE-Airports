<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FSE Airports Map</title>

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet.glify -->
  <script src="https://unpkg.com/leaflet.glify@3.0.0/dist/leaflet.glify.min.js"></script>

  <!-- Choices.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <style>
    html, body { margin: 0; padding: 0; height: 100%; width: 100%; }
    #map { width: 100%; height: 100%; z-index: 1; }

    /* Buttons */
    #filter-toggle, #search-toggle {
      position: absolute;
      top: 10px;
      background: #fff;
      border: 1px solid #ccc;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      z-index: 1001;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    #filter-toggle { right: 10px; }
    #search-toggle { right: 90px; }

    /* Flyout panels */
    .flyout {
      position: absolute;
      top: 50px;
      width: 260px;
      background: white;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      font-family: sans-serif;
      font-size: 13px;
      z-index: 1000;
      max-height: 80%;
      overflow-y: auto;
      transition: transform 0.25s ease, opacity 0.25s ease;
    }
    .flyout.hidden {
      transform: translateX(280px);
      opacity: 0;
      pointer-events: none;
    }
    #filter-box { right: 10px; }
    #search-box { right: 90px; }

    /* Layout */
    #filter-box h3, #search-box h3 { margin-top: 0; text-align: center; }
    .runway-inputs { display: flex; gap: 4px; }
    .runway-inputs input { flex: 1; max-width: 100px; }

    .buttons { display: flex; justify-content: space-between; gap: 8px; margin-top: 8px; }
    .buttons button {
      flex: 1; cursor: pointer; border: none; border-radius: 4px;
      padding: 6px 0; font-weight: bold; color: white;
    }
    #applyFilters { background-color: #007bff; }
    #resetFilters { background-color: #6c757d; }

    #search-box input { width: 100%; margin-bottom: 6px; padding: 4px; }
    #search-box button {
      width: 100%; padding: 6px; background: #28a745;
      color: white; border: none; border-radius: 4px; cursor: pointer;
    }
    #search-box button:hover { background: #1e7b32; }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- Filter Panel -->
  <div id="filter-toggle">‚ò∞ Filters</div>
  <div id="filter-box" class="flyout hidden">
    <h3>Filter Airports</h3>
    <label>Type:</label>
    <select id="typeFilter" multiple>
      <option value="civil">Civil</option>
      <option value="water">Water</option>
      <option value="military">Military</option>
    </select>

    <label>Size:</label>
    <select id="sizeFilter" multiple>
      <option value="small">Small</option>
      <option value="medium">Medium</option>
      <option value="large">Large</option>
    </select>

    <label>Surface:</label>
    <select id="surfaceFilter" multiple></select>

    <label>Runway Length (ft):</label>
    <div class="runway-inputs">
      <input type="number" id="minRunway" placeholder="Min" />
      <input type="number" id="maxRunway" placeholder="Max" />
    </div>

    <div class="buttons">
      <button id="applyFilters">Apply</button>
      <button id="resetFilters">Reset</button>
    </div>
  </div>

  <!-- Search Panel -->
  <div id="search-toggle">üîç Search</div>
  <div id="search-box" class="flyout hidden">
    <h3>Search Airports</h3>
    <label>ICAO:</label>
    <input type="text" id="icaoSearch" placeholder="e.g., KJFK" />

    <label>City:</label>
    <input type="text" id="citySearch" placeholder="e.g., New York" />

    <label>Lat, Lon:</label>
    <input type="text" id="latlonSearch" placeholder="e.g., 40.7128,-74.0060" />

    <button id="goSearch">Go</button>
  </div>

  <script>
    // === TOGGLES ===
    const filterBox = document.getElementById('filter-box');
    const searchBox = document.getElementById('search-box');
    document.getElementById('filter-toggle').addEventListener('click', () => filterBox.classList.toggle('hidden'));
    document.getElementById('search-toggle').addEventListener('click', () => searchBox.classList.toggle('hidden'));

    // === INIT CHOICES ===
    const typeChoices = new Choices('#typeFilter', { removeItemButton: true });
    const sizeChoices = new Choices('#sizeFilter', { removeItemButton: true });
    const surfaceChoices = new Choices('#surfaceFilter', { removeItemButton: true });

    // === MAP SETUP ===
    const map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    const typeColor = { civil: '#2ca02c', water: '#1f77b4', military: '#d62728' };
    const getRadius = size => (size < 1000 ? 3 : size < 3500 ? 6 : 9);

    let allFeatures = [];
    let layerGroup = L.layerGroup().addTo(map);

    fetch('https://raw.githubusercontent.com/jrow73/FSE-Airports/main/airports.geojson')
      .then(res => res.json())
      .then(geojson => {
        allFeatures = geojson.features;
        // Populate surface dropdown
        const uniqueSurfaces = [...new Set(allFeatures.map(f => f.properties.surfaceType).filter(Boolean))].sort();
        surfaceChoices.clearStore();
        uniqueSurfaces.forEach(s => surfaceChoices.setChoices([{ value: s, label: s }], 'value', 'label', false));

        renderFeatures(allFeatures);
      })
      .catch(err => console.error('Error loading GeoJSON:', err));

    function renderFeatures(features) {
      layerGroup.clearLayers();
      features.forEach(f => {
        const p = f.properties;
        const circle = L.circleMarker([f.geometry.coordinates[1], f.geometry.coordinates[0]], {
          radius: getRadius(p.size),
          fillColor: typeColor[p.type] || '#888',
          color: '#000',
          weight: 0.5,
          fillOpacity: 0.8
        });
        circle.bindPopup(`
          <strong>${p.icao ? `${p.icao}<br/>` : ''}
          ${p.name || 'Unknown'}<br/>
          ${p.city ? `${p.city}, ${p.state || ''}, ${p.country}</strong><br/>` : ''}
          Elev: ${p.elev} ft<br/>
          Longest Runway: ${p.longestRwy}ft of 
          Surface: ${p.surfaceType}<br/>
          Services: ${p.services}
        `);
        layerGroup.addLayer(circle);
      });
    }

    // === FILTER HANDLERS ===
    document.getElementById('applyFilters').addEventListener('click', () => {
      const selectedTypes = typeChoices.getValue(true);
      const selectedSizes = sizeChoices.getValue(true);
      const selectedSurfaces = surfaceChoices.getValue(true);
      const minRwy = parseFloat(document.getElementById('minRunway').value) || 0;
      const maxRwy = parseFloat(document.getElementById('maxRunway').value) || Infinity;

      const filtered = allFeatures.filter(f => {
        const p = f.properties;
        if (selectedTypes.length && !selectedTypes.includes(p.type)) return false;
        if (selectedSurfaces.length && !selectedSurfaces.includes(p.surfaceType)) return false;
        if (selectedSizes.length) {
          const cat = p.size < 1000 ? 'small' : p.size < 3500 ? 'medium' : 'large';
          if (!selectedSizes.includes(cat)) return false;
        }
        if (p.longestRwy < minRwy || p.longestRwy > maxRwy) return false;
        return true;
      });

      renderFeatures(filtered);
    });

    document.getElementById('resetFilters').addEventListener('click', () => {
      typeChoices.removeActiveItems();
      sizeChoices.removeActiveItems();
      surfaceChoices.removeActiveItems();
      document.getElementById('minRunway').value = '';
      document.getElementById('maxRunway').value = '';
      renderFeatures(allFeatures);
    });

// === SEARCH FUNCTION ===
let tempMarker = null; // store the temporary marker if user searches coords

document.getElementById('goSearch').addEventListener('click', () => {
  const icaoVal = document.getElementById('icaoSearch').value.trim().toLowerCase();
  const cityVal = document.getElementById('citySearch').value.trim().toLowerCase();
  const latlonVal = document.getElementById('latlonSearch').value.trim();

  let targetLatLng = null;
  let foundFeature = null;

  // --- 1Ô∏è‚É£ Search by ICAO or City ---
  if ((icaoVal || cityVal) && allFeatures.length) {
    foundFeature = allFeatures.find(f => {
      const p = f.properties;
      const matchesICAO = icaoVal && p.icao?.toLowerCase() === icaoVal;
      const matchesCity = cityVal && p.city?.toLowerCase().includes(cityVal);
      return matchesICAO || matchesCity;
    });
    if (foundFeature) {
      targetLatLng = [foundFeature.geometry.coordinates[1], foundFeature.geometry.coordinates[0]];
    }
  }

  // --- 2Ô∏è‚É£ Search by coordinate input ---
  if (!targetLatLng && latlonVal.includes(',')) {
    const parts = latlonVal.split(',');
    if (parts.length === 2) {
      let latStr = parts[0].trim();
      let lonStr = parts[1].trim();

      // detect hemisphere letters and remove them
      const hasN = /[nN]$/.test(latStr);
      const hasS = /[sS]$/.test(latStr);
      const hasE = /[eE]$/.test(lonStr);
      const hasW = /[wW]$/.test(lonStr);

      latStr = latStr.replace(/[nNsS]/g, '');
      lonStr = lonStr.replace(/[eEwW]/g, '');

      let lat = parseFloat(latStr);
      let lon = parseFloat(lonStr);

      if (isNaN(lat) || isNaN(lon)) {
        alert('Invalid coordinate format.');
        return;
      }

      // apply hemisphere sign
      if (hasS) lat = -Math.abs(lat);
      if (hasN) lat = Math.abs(lat);
      if (hasW) lon = -Math.abs(lon);
      if (hasE) lon = Math.abs(lon);

      targetLatLng = [lat, lon];
    }
  }

  // --- 3Ô∏è‚É£ If a result is found ---
  if (targetLatLng) {
    map.setView(targetLatLng, 10);

    // remove old temporary marker if it exists
    if (tempMarker) {
      map.removeLayer(tempMarker);
      tempMarker = null;
    }

    if (foundFeature) {
      // open popup for found airport
      L.popup()
        .setLatLng(targetLatLng)
        .setContent(`<strong>${foundFeature.properties.name}</strong><br/>${foundFeature.properties.city || ''}`)
        .openOn(map);
    } else {
      // no matching airport ‚Äî drop temporary marker
      tempMarker = L.marker(targetLatLng).addTo(map);
      tempMarker.bindPopup(
        `Custom location:<br/>Lat: ${targetLatLng[0].toFixed(5)}, Lon: ${targetLatLng[1].toFixed(5)}`
      ).openPopup();
    }

    // close search panel
    searchBox.classList.add('hidden');
  } else {
    alert('No matching location found.');
  }
});

  </script>
</body>
</html>
