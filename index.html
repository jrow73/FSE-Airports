<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FSE Airports Map</title>

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet.glify -->
  <script src="https://unpkg.com/leaflet.glify@3.0.0/dist/leaflet.glify.min.js"></script>

  <!-- Choices.js for enhanced dropdowns -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <style>
    html, body { margin: 0; padding: 0; height: 100%; width: 100%; }
    #map { width: 100%; height: 100%; z-index: 1; }

    #filter-toggle {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #fff;
      border: 1px solid #ccc;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      z-index: 1001;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    #filter-box {
      position: absolute;
      top: 50px;
      left: 10px;
      width: 260px;
      background: white;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      font-family: sans-serif;
      font-size: 13px;
      z-index: 1000;
      max-height: 80%;
      overflow-y: auto;
      transition: transform 0.25s ease, opacity 0.25s ease;
    }

    #filter-box.hidden {
      transform: translateX(-280px);
      opacity: 0;
      pointer-events: none;
    }

    #filter-box h3 {
      margin-top: 0;
      text-align: center;
    }

    .buttons {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .buttons button {
      flex: 1;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      padding: 6px 0;
      font-weight: bold;
      color: white;
    }

    #applyFilters { background-color: #007bff; }
    #resetFilters { background-color: #6c757d; }

    .leaflet-popup-content { font-size: 13px; line-height: 1.4em; }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- Collapsible Filter Box -->
  <div id="filter-toggle">â˜° Filters</div>
  <div id="filter-box" class="hidden">
    <h3>Filter Airports</h3>

    <label>Type:</label>
    <select id="typeFilter" multiple>
      <option value="civil">Civil</option>
      <option value="water">Water</option>
      <option value="military">Military</option>
    </select>

    <label>Size:</label>
    <select id="sizeFilter" multiple>
      <option value="small">Small</option>
      <option value="medium">Medium</option>
      <option value="large">Large</option>
    </select>

    <label>Surface:</label>
    <select id="surfaceFilter" multiple></select>

    <label>Runway Length (ft):</label>
    <div style="display:flex; gap:4px;">
      <input type="number" id="minRunway" placeholder="Min" />
      <input type="number" id="maxRunway" placeholder="Max" />
    </div>

    <div class="buttons">
      <button id="applyFilters">Apply</button>
      <button id="resetFilters">Reset</button>
    </div>
  </div>

  <script>
    // Toggle filter panel
    const filterBox = document.getElementById('filter-box');
    const toggleBtn = document.getElementById('filter-toggle');
    toggleBtn.addEventListener('click', () => filterBox.classList.toggle('hidden'));

    // Initialize Choices.js dropdowns
    const typeChoices = new Choices('#typeFilter', { removeItemButton: true });
    const sizeChoices = new Choices('#sizeFilter', { removeItemButton: true });
    const surfaceChoices = new Choices('#surfaceFilter', { removeItemButton: true });

    // === MAP INITIALIZATION ===
    const map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    const typeColor = { civil: '#2ca02c', water: '#1f77b4', military: '#d62728' };
    function getRadius(size) {
      if (size < 1000) return 3;
      if (size < 3500) return 6;
      return 9;
    }

    fetch('https://raw.githubusercontent.com/jrow73/FSE-Airports/main/airports.geojson')
      .then(res => res.json())
      .then(geojson => {
        const allFeatures = geojson.features;

        // Populate surface filter dynamically
        const uniqueSurfaces = [...new Set(allFeatures.map(f => f.properties.surfaceType).filter(Boolean))].sort();
        surfaceChoices.clearStore();
        uniqueSurfaces.forEach(s => surfaceChoices.setChoices([{ value: s, label: s }], 'value', 'label', false));

        let layerGroup = L.layerGroup().addTo(map);

        function renderFeatures(features) {
          layerGroup.clearLayers();
          features.forEach(f => {
            const p = f.properties;
            const circle = L.circleMarker([f.geometry.coordinates[1], f.geometry.coordinates[0]], {
              radius: getRadius(p.size),
              fillColor: typeColor[p.type] || '#888',
              color: '#000',
              weight: 0.5,
              fillOpacity: 0.8
            });
            const popupHtml = `
              <strong>${p.name || 'Unknown'}</strong><br/>
              ${p.city || ''}, ${p.state || ''}<br/>
              Type: ${p.type}<br/>
              Size: ${p.size}<br/>
              Elev: ${p.elev} ft<br/>
              Runway: ${p.longestRwy} ft<br/>
              Surface: ${p.surfaceType}<br/>
              Services: ${p.services}
            `;
            circle.bindPopup(popupHtml);
            layerGroup.addLayer(circle);
          });
        }

        renderFeatures(allFeatures);

        document.getElementById('applyFilters').addEventListener('click', () => {
          const selectedTypes = typeChoices.getValue(true);
          const selectedSizes = sizeChoices.getValue(true);
          const selectedSurfaces = surfaceChoices.getValue(true);
          const minRwy = parseFloat(document.getElementById('minRunway').value) || 0;
          const maxRwy = parseFloat(document.getElementById('maxRunway').value) || Infinity;

          const filtered = allFeatures.filter(f => {
            const p = f.properties;
            if (selectedTypes.length && !selectedTypes.includes(p.type)) return false;
            if (selectedSurfaces.length && !selectedSurfaces.includes(p.surfaceType)) return false;
            if (selectedSizes.length) {
              const cat = p.size < 1000 ? 'small' : p.size < 3500 ? 'medium' : 'large';
              if (!selectedSizes.includes(cat)) return false;
            }
            if (p.longestRwy < minRwy || p.longestRwy > maxRwy) return false;
            return true;
          });

          renderFeatures(filtered);
        });

        document.getElementById('resetFilters').addEventListener('click', () => {
          typeChoices.removeActiveItems();
          sizeChoices.removeActiveItems();
          surfaceChoices.removeActiveItems();
          document.getElementById('minRunway').value = '';
          document.getElementById('maxRunway').value = '';
          renderFeatures(allFeatures);
        });
      })
      .catch(err => console.error('Error loading GeoJSON:', err));
  </script>
</body>
</html>
