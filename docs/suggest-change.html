<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Suggest Airport Change</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f5f5f5;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    h1 {
      margin-top: 0;
      font-size: 1.4rem;
    }
    .grid {
      display: grid;
      grid-template-columns: 1.2fr 1.2fr 1.8fr;
      gap: 0.5rem 1rem;
      align-items: center;
    }
    .grid-header {
      font-weight: 600;
      border-bottom: 1px solid #ddd;
      padding-bottom: 0.25rem;
    }
    .label {
      font-weight: 500;
      font-size: 0.9rem;
    }
    .current-value {
      font-size: 0.9rem;
      color: #555;
    }
    input[type="text"], textarea, select {
      width: 100%;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 0.9rem;
      padding: 0.25rem 0.4rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    .buttons {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
    }
    button {
      border: none;
      border-radius: 4px;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .btn-primary {
      background: #2563eb;
      color: #fff;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .status {
      margin-top: 0.75rem;
      font-size: 0.9rem;
    }
    .status.ok { color: #15803d; }
    .status.error { color: #b91c1c; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Suggest changes to the FSE airport at this map position.</h1>
        <p id="airport-summary"></p>
        <hr />NOTE: If there is no IRL airport at all at this position and the 
        IRL ICAO has a value assigned, propose the IRL ICAO as "XXXX" 
        <hr /><br />

    <form id="change-form">
      <input type="hidden" name="type" value="change">
      <input type="hidden" id="icao-input" name="icao">
      <input type="hidden" name="source" value="FSE Map Viewer">

      <div class="grid">
        <div class="grid-header">Field</div>
        <div class="grid-header">Current</div>
        <div class="grid-header">Proposed value</div>

        <!-- IRL ICAO -->
        <div class="label">IRL ICAO (real-world)</div>
        <div class="current-value" id="cur-icao"></div>
        <div>
          <input
            type="text"
            name="proposed_icao"
            id="proposed_icao"
            placeholder="If IRL ICAO is incorrect"
            maxlength="4"
          >
        </div>

        <!-- Name -->
        <div class="label">Name</div>
        <div class="current-value" id="cur-name"></div>
        <div><input type="text" name="proposed_name" placeholder="Correct name"></div>

        <!-- City -->
        <div class="label">City</div>
        <div class="current-value" id="cur-city"></div>
        <div><input type="text" name="proposed_city" placeholder="Correct city"></div>

        <!-- State -->
        <div class="label">State</div>
        <div class="current-value" id="cur-state"></div>
        <div><input type="text" name="proposed_state" placeholder="Correct state/region"></div>

        <!-- Country -->
        <div class="label">Country</div>
        <div class="current-value" id="cur-country"></div>
        <div><input type="text" name="proposed_country" placeholder="Correct country"></div>

        <!-- Elevation -->
        <div class="label">Elevation (ft)</div>
        <div class="current-value" id="cur-elev"></div>
        <div>
          <input
            type="text"
            name="proposed_elev"
            id="proposed_elev"
            placeholder="Correct elevation"
            maxlength="5"
          >
        </div>

        <!-- Longest runway -->
        <div class="label">Longest runway (ft)</div>
        <div class="current-value" id="cur-longest"></div>
        <div>
          <input
            type="text"
            name="proposed_longest"
            id="proposed_longest"
            placeholder="Correct length"
            maxlength="5"
          >
        </div>

        <!-- Surface type -->
        <div class="label">Surface type</div>
        <div class="current-value" id="cur-surface"></div>
        <div>
          <select name="proposed_surface" id="proposed_surface">
            <option value="">(no change)</option>
            <option>Asphalt</option>
            <option>Concrete</option>
            <option>Coral</option>
            <option>Dirt</option>
            <option>Grass</option>
            <option>Gravel</option>
            <option>Helipad</option>
            <option>Oil Treated</option>
            <option>Snow</option>
            <option>Steel Mats</option>
            <option>Water</option>
          </select>
        </div>
      </div>

      <div style="margin-top:1rem;">
        <label for="comments"><strong>Additional comments</strong></label>
        <textarea id="comments" name="comments" placeholder="Anything else we should know?"></textarea>
      </div>

      <div class="buttons">
        <button type="submit" class="btn-primary">Submit suggestion</button>
        <button type="button" class="btn-secondary" onclick="window.close()">Close</button>
      </div>

      <div id="status" class="status"></div>
    </form>
  </div>

  <script>
    const FORM_ACTION_URL = 'https://script.google.com/macros/s/AKfycbyK-kXfWHPG_3mQCT9WkeHXoGHeWsjZ_H9G8ThlfyWUz529_xVwWxUP5WxfUkQANOjoIQ/exec';

    function getQueryParams() {
      const params = {};
      const search = window.location.search.substring(1);
      if (!search) return params;
      search.split('&').forEach(pair => {
        const [k, v] = pair.split('=');
        params[decodeURIComponent(k)] = decodeURIComponent(v || '');
      });
      return params;
    }

    function initNumericFilters() {
      // Only digits, max 5 characters
      ['proposed_elev', 'proposed_longest'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('input', () => {
          el.value = el.value.replace(/\D/g, '').slice(0, 5);
        });
      });
    }

    function validateChangeForm() {
      const statusEl = document.getElementById('status');
      const icao = document.getElementById('proposed_icao').value.trim();
      const elev = document.getElementById('proposed_elev').value.trim();
      const longest = document.getElementById('proposed_longest').value.trim();

  // ICAO: optional, but if present must be 3 or 4 alphanumeric characters
  if (icao && !/^[A-Za-z0-9]{3,4}$/.test(icao)) {
    statusEl.textContent = 'ICAO must be 3 or 4 alphanumeric characters (A–Z, 0–9).';
    statusEl.className = 'status error';
    return false;
  }

      // Elevation: digits only, max 5 (input filter already enforces; this is just a sanity check)
      if (elev && !/^[0-9]{1,5}$/.test(elev)) {
        statusEl.textContent = 'Elevation must be numeric only (up to 5 digits).';
        statusEl.className = 'status error';
        return false;
      }

      // Longest: digits only, max 5
      if (longest && !/^[0-9]{1,5}$/.test(longest)) {
        statusEl.textContent = 'Longest runway must be numeric only (up to 5 digits).';
        statusEl.className = 'status error';
        return false;
      }

      return true;
    }

    function init() {
      const params = getQueryParams();

      // FSE ICAO = permanent key
      const fseIcao = (params.icao || '').toUpperCase();
      // IRL ICAO = real-world code (may be null / empty)
      const irlIcao = (params.irlicao || '').toUpperCase();

      const name     = params.name || '';
      const city     = params.city || '';
      const state    = params.state || '';
      const country  = params.country || '';
      const elev     = params.elev || '';
      const longest  = params.longestRwy || params.longest || '';
      const surface  = params.surfaceType || '';

      // Hidden field: what we send to the sheet / Apps Script as the key
      document.getElementById('icao-input').value = fseIcao;

// Build stylized summary card
const summaryEl = document.getElementById('airport-summary');

// Determine ICAO display rules
let icaoLine = '';

if (fseIcao && irlIcao && fseIcao !== irlIcao) {
  // Different FSE and IRL ICAOs
  icaoLine = `
    <div class="icao-line">
      <span class="icao fse">FSE: ${fseIcao}</span>
      <span class="icao irl">IRL: ${irlIcao}</span>
    </div>`;
} else if (fseIcao && irlIcao && fseIcao === irlIcao) {
  // Same ICAO
  icaoLine = `
    <div class="icao-line">
      <span class="icao both">ICAO: ${fseIcao}</span>
    </div>`;
} else if (fseIcao && !irlIcao) {
  // No IRL ICAO – closed airport
  icaoLine = `
    <div class="icao-line">
      <span class="icao fse">FSE: ${fseIcao}</span>
      <span class="icao closed">(Closed)</span>
    </div>`;
} else {
  // No ICAO at all
  icaoLine = `
    <div class="icao-line">
      <span class="icao closed">(No ICAO on file)</span>
    </div>`;
}

const locationLine = [city, state, country].filter(Boolean).join(', ');

// Inject card HTML
summaryEl.innerHTML = `
  <div class="airport-card">
    ${icaoLine}
    <div class="airport-name">${name || ''}</div>
    <div class="airport-location">${locationLine}</div>
  </div>
`;

// Add CSS styles dynamically (safe inside the page)
const style = document.createElement('style');
style.textContent = `
  .airport-card {
    background: #f9fafb;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    padding: 12px 14px;
    margin-bottom: 10px;
  }
  .icao-line {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 6px;
  }
  .icao {
    margin-right: 12px;
  }
  .icao.fse { color: #1e40af; }     /* blue */
  .icao.irl { color: #047857; }     /* green */
  .icao.both { color: #1e3a8a; }    /* navy */
  .icao.closed { color: #b91c1c; }  /* red */
  .airport-name {
    font-weight: bold;
    font-size: 1.05rem;
    margin-bottom: 2px;
  }
  .airport-location {
    color: #374151;
    font-size: 0.9rem;
  }
`;
document.head.appendChild(style);


      // In the grid, "current ICAO" = IRL ICAO, not FSE ICAO
      document.getElementById('cur-icao').textContent    = irlIcao || '(none on file)';
      document.getElementById('cur-name').textContent    = name;
      document.getElementById('cur-city').textContent    = city;
      document.getElementById('cur-state').textContent   = state;
      document.getElementById('cur-country').textContent = country;
      document.getElementById('cur-elev').textContent    = elev;
      document.getElementById('cur-longest').textContent = longest;
      document.getElementById('cur-surface').textContent = surface;

      initNumericFilters();

      const form = document.getElementById('change-form');
      const statusEl = document.getElementById('status');

      form.addEventListener('submit', async (evt) => {
        evt.preventDefault();
        statusEl.textContent = '';
        statusEl.className = 'status';

        if (!validateChangeForm()) {
          return;
        }

        statusEl.textContent = 'Sending...';

        const formData = new FormData(form);

        const currentMap = {
          icao: irlIcao || '',
          name: name,
          city: city,
          state: state,
          country: country,
          elev: elev,
          longest: longest,
          surface: surface
        };

        const proposedFields = [
          ['IRL ICAO', 'proposed_icao', 'icao'],
          ['Name', 'proposed_name', 'name'],
          ['City', 'proposed_city', 'city'],
          ['State', 'proposed_state', 'state'],
          ['Country', 'proposed_country', 'country'],
          ['Elevation (ft)', 'proposed_elev', 'elev'],
          ['Longest runway (ft)', 'proposed_longest', 'longest'],
          ['Surface type', 'proposed_surface', 'surface']
        ];


        const userComments = (formData.get('comments') || '').toString().trim();

        const changes = [];

        // Build changes array: one entry per field that has a proposed value
        proposedFields.forEach(([label, propName, currentKey]) => {
          const raw = formData.get(propName);
          const proposedVal = raw ? raw.toString().trim() : '';
          if (!proposedVal) return; // skip unchanged fields

          changes.push({
            fieldName: label,
            currentValue: currentMap[currentKey] || '',
            proposedValue: proposedVal
          });
        });

        // If there were no field changes but the user left a general comment,
        // record that as a single "General" row.
        if (changes.length === 0 && userComments) {
          changes.push({
            fieldName: 'General',
            currentValue: '',
            proposedValue: ''
          });
        }

        // If absolutely nothing was entered, show an error
        if (changes.length === 0) {
          statusEl.textContent = 'Please propose at least one change or add a comment.';
          statusEl.className = 'status error';
          return;
        }

        const payload = new URLSearchParams();
        payload.append('type', 'change');
        payload.append('icao', fseIcao); // FSE ICAO Key
        payload.append('comments', userComments);
        payload.append('changes', JSON.stringify(changes));

        try {
          await fetch(FORM_ACTION_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: payload
          });

          statusEl.textContent = 'Thank you! Your suggestion has been recorded.';
          statusEl.className = 'status ok';
          form.reset();
        } catch (err) {
          console.error(err);
          statusEl.textContent = 'Sorry, something went wrong submitting your suggestion.';
          statusEl.className = 'status error';
        }
      });

    }

    init();
  </script>
</body>
</html>
