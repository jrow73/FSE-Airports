<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Suggest Airport Change</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f5f5f5;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    h1 {
      margin-top: 0;
      font-size: 1.4rem;
    }
    .grid {
      display: grid;
      grid-template-columns: 1.2fr 1.2fr 1.8fr;
      gap: 0.5rem 1rem;
      align-items: center;
    }
    .grid-header {
      font-weight: 600;
      border-bottom: 1px solid #ddd;
      padding-bottom: 0.25rem;
    }
    .label {
      font-weight: 500;
      font-size: 0.9rem;
    }
    .current-value {
      font-size: 0.9rem;
      color: #555;
    }
    input[type="text"], textarea {
      width: 100%;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 0.9rem;
      padding: 0.25rem 0.4rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    .buttons {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
    }
    button {
      border: none;
      border-radius: 4px;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .btn-primary {
      background: #2563eb;
      color: #fff;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .status {
      margin-top: 0.75rem;
      font-size: 0.9rem;
    }
    .status.ok { color: #15803d; }
    .status.error { color: #b91c1c; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Suggest changes to this airport</h1>
    <p id="airport-summary"></p>

    <form id="change-form">
      <input type="hidden" name="type" value="change">
      <input type="hidden" id="icao-input" name="icao">
      <input type="hidden" name="source" value="FSE Map Viewer">

      <div class="grid">
        <div class="grid-header">Field</div>
        <div class="grid-header">Current</div>
        <div class="grid-header">Proposed value</div>

        <!-- ICAO -->
        <div class="label">ICAO</div>
        <div class="current-value" id="cur-icao"></div>
        <div><input type="text" name="proposed_icao" placeholder="If ICAO is incorrect"></div>

        <!-- Name -->
        <div class="label">Name</div>
        <div class="current-value" id="cur-name"></div>
        <div><input type="text" name="proposed_name" placeholder="Correct name"></div>

        <!-- City -->
        <div class="label">City</div>
        <div class="current-value" id="cur-city"></div>
        <div><input type="text" name="proposed_city" placeholder="Correct city"></div>

        <!-- State -->
        <div class="label">State</div>
        <div class="current-value" id="cur-state"></div>
        <div><input type="text" name="proposed_state" placeholder="Correct state/region"></div>

        <!-- Country -->
        <div class="label">Country</div>
        <div class="current-value" id="cur-country"></div>
        <div><input type="text" name="proposed_country" placeholder="Correct country"></div>

        <!-- Elevation -->
        <div class="label">Elevation (ft)</div>
        <div class="current-value" id="cur-elev"></div>
        <div><input type="text" name="proposed_elev" placeholder="Correct elevation"></div>

        <!-- Longest runway -->
        <div class="label">Longest runway (ft)</div>
        <div class="current-value" id="cur-longest"></div>
        <div><input type="text" name="proposed_longest" placeholder="Correct length"></div>
      </div>

      <div style="margin-top:1rem;">
        <label for="comments"><strong>Additional comments</strong></label>
        <textarea id="comments" name="comments" placeholder="Anything else we should know?"></textarea>
      </div>

      <div class="buttons">
        <button type="submit" class="btn-primary">Submit suggestion</button>
        <button type="button" class="btn-secondary" onclick="window.close()">Close</button>
      </div>

      <div id="status" class="status"></div>
    </form>
  </div>

  <script>
    const FORM_ACTION_URL = 'PASTE_YOUR_WEB_APP_URL_HERE';

    function getQueryParams() {
      const params = {};
      const search = window.location.search.substring(1);
      if (!search) return params;
      search.split('&').forEach(pair => {
        const [k, v] = pair.split('=');
        params[decodeURIComponent(k)] = decodeURIComponent(v || '');
      });
      return params;
    }

    function init() {
      const params = getQueryParams();

      // Fill summary + current values from query string
      const icao     = params.icao || '';
      const name     = params.name || '';
      const city     = params.city || '';
      const state    = params.state || '';
      const country  = params.country || '';
      const elev     = params.elev || '';
      const longest  = params.longestRwy || params.longest || '';

      document.getElementById('icao-input').value = icao;
      document.getElementById('airport-summary').textContent =
        (icao ? icao + ' — ' : '') + [name, city, state, country].filter(Boolean).join(', ');

      document.getElementById('cur-icao').textContent    = icao;
      document.getElementById('cur-name').textContent    = name;
      document.getElementById('cur-city').textContent    = city;
      document.getElementById('cur-state').textContent   = state;
      document.getElementById('cur-country').textContent = country;
      document.getElementById('cur-elev').textContent    = elev;
      document.getElementById('cur-longest').textContent = longest;

      // Handle form submission
      const form = document.getElementById('change-form');
      const statusEl = document.getElementById('status');

      form.addEventListener('submit', async (evt) => {
        evt.preventDefault();
        statusEl.textContent = 'Sending...';
        statusEl.className = 'status';

        const formData = new FormData(form);

        // Flatten our multiple proposed fields into individual rows in the Sheet
        // For simplicity, we’ll send ONE row per field on this endpoint,
        // but to keep code small we’ll just bundle into comments + fieldName.
        // If you prefer one row with many columns, we can change the script.

        // For now: send one "combined" record describing all props at once:
        // Compose a text blob of changed fields in comments, and set fieldName="Multiple".
        let changesText = '';
        const currentMap = {
          icao: icao,
          name: name,
          city: city,
          state: state,
          country: country,
          elev: elev,
          longest: longest
        };

        const proposedFields = [
          ['ICAO', 'proposed_icao', 'icao'],
          ['Name', 'proposed_name', 'name'],
          ['City', 'proposed_city', 'city'],
          ['State', 'proposed_state', 'state'],
          ['Country', 'proposed_country', 'country'],
          ['Elevation (ft)', 'proposed_elev', 'elev'],
          ['Longest runway (ft)', 'proposed_longest', 'longest']
        ];

        proposedFields.forEach(([label, propName, currentKey]) => {
          const val = formData.get(propName);
          if (val && val.trim() !== '') {
            changesText += label + ': "' + (currentMap[currentKey] || '') +
              '" → "' + val.trim() + '"\n';
          }
        });

        const userComments = formData.get('comments') || '';
        const combinedComments = (changesText ? changesText + '\n' : '') + userComments;

        // Now build minimal payload the Apps Script expects:
        const payload = new URLSearchParams();
        payload.append('type', 'change');
        payload.append('icao', icao);
        payload.append('fieldName', 'Multiple');
        payload.append('currentValue', '');
        payload.append('proposedValue', '');
        payload.append('comments', combinedComments);
        payload.append('source', 'FSE Map Viewer');

        try {
          const res = await fetch(FORM_ACTION_URL, {
            method: 'POST',
            mode: 'no-cors', // Apps Script may require this from static sites
            body: payload
          });

          statusEl.textContent = 'Thank you! Your suggestion has been recorded.';
          statusEl.className = 'status ok';
          form.reset();
        } catch (err) {
          console.error(err);
          statusEl.textContent = 'Sorry, something went wrong submitting your suggestion.';
          statusEl.className = 'status error';
        }
      });
    }

    init();
  </script>
</body>
</html>
